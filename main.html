<html>
 
  <script src="https://aframe.io/releases/0.3.0/aframe.js"></script>
  <script src="https://cdn.rawgit.com/AltspaceVR/AltspaceSDK/v2.4.0/dist/altspace.js"></script>

  <a-scene altspace="fullspace: true" sync-system="author: greeny3ny; app: dancedance">

	<!-- removing this makes it not work?? -->
    <a-assets>
	  <a-asset-item id="songs" src="https://rawgit.com/greeny3ny/VRDance/master/songs/songs.json"></a-asset-item>
    </a-assets>

	<a-mixin id="parent-to-chest" position="0 0 0" n-skeleton-parent="part: spine;" scale="1.1 1 1.1" sync sync-n-skeleton-parent></a-mixin>
	<a-box id="box4" hancol="box_id:4;" n-mesh-collider="type:hologram" color="red" position="0 1.5 -0.7" scale="0.25 0.25 1" opacity="0.2">
		<a-animation attribute="material.color" begin="touch" from="red" to="yellow" dur="1"></a-animation>
		<a-animation attribute="material.color" begin="left" from="yellow" to="red" dur="1"></a-animation>
	</a-box>
	
	
	<a-box id="box5" hancol="box_id:5;" n-mesh-collider="type:hologram" color="red" position="0.5 1.5 -0.7" scale="0.25 0.25 1" opacity="0.2">
		<a-animation attribute="material.color" begin="touch" from="red" to="yellow" dur="1"></a-animation>
		<a-animation attribute="material.color" begin="left" from="yellow" to="red" dur="1"></a-animation>
	</a-box>
	
	<a-box id="box3" hancol="box_id:3;" n-mesh-collider="type:hologram" color="red" position="-0.5 1.5 -0.7" scale="0.25 0.25 1" opacity="0.2">
		<a-animation attribute="material.color" begin="touch" from="red" to="yellow" dur="1"></a-animation>
		<a-animation attribute="material.color" begin="left" from="yellow" to="red" dur="1"></a-animation>
	</a-box>
	
	<a-box id="box1" hancol="box_id:1;" n-mesh-collider="type:hologram" color="red" position="0 2 -0.7" scale="0.25 0.25 1" opacity="0.2">
		<a-animation attribute="material.color" begin="touch" from="red" to="yellow" dur="1"></a-animation>
		<a-animation attribute="material.color" begin="left" from="yellow" to="red" dur="1"></a-animation>
	</a-box>
	
	
	<a-box id="box2" hancol="box_id:2;" n-mesh-collider="type:hologram" color="red" position="0.5 2 -0.7" scale="0.25 0.25 1" opacity="0.2">
		<a-animation attribute="material.color" begin="touch" from="red" to="yellow" dur="1"></a-animation>
		<a-animation attribute="material.color" begin="left" from="yellow" to="red" dur="1"></a-animation>
	</a-box>
	<a-box id="box0" hancol="box_id:0;" color="green" position="-0.5 2 -0.7" scale="0.25 0.25 1" opacity="0.2" >
		<a-animation attribute="material.color" begin="touch" from="red" to="yellow" dur="1"></a-animation>
		<a-animation attribute="material.color" begin="left" from="yellow" to="red" dur="1"></a-animation>
	</a-box>
	
	<a-box id="box7" hancol="box_id:7;" color="green" position="0 1 -0.7" scale="0.25 0.25 1" opacity="0.2" >
		<a-animation attribute="material.color" begin="touch" from="red" to="yellow" dur="1"></a-animation>
		<a-animation attribute="material.color" begin="left" from="yellow" to="red" dur="1"></a-animation>
	</a-box>
	<a-box id="box8" hancol="box_id:8;" color="green" position="0.5 1 -0.7" scale="0.25 0.25 1" opacity="0.2" >
		<a-animation attribute="material.color" begin="touch" from="red" to="yellow" dur="1"></a-animation>
		<a-animation attribute="material.color" begin="left" from="yellow" to="red" dur="1"></a-animation>
	</a-box>
	<a-box id="box6" hancol="box_id:6;" color="green" position="-0.5 1 -0.7" scale="0.25 0.25 1" opacity="0.2" >
		<a-animation attribute="material.color" begin="touch" from="red" to="yellow" dur="1"></a-animation>
		<a-animation attribute="material.color" begin="left" from="yellow" to="red" dur="1"></a-animation>
	</a-box>
	
	<!-- temporary display -->
	<a-entity id="tempDisplay" position='0 1 -5' rotation='0 0 0' n-text='text: test ; fontSize:3; width:1;'></a-entity>
	
	<a-entity id="hitDisplay" position='0 2 -5' rotation='0 0 0' n-text='text: test ; fontSize:3; width:1;'></a-entity>
	<a-entity id="statsDisplay" position='0 3 -5' rotation='0 0 0' n-text='text:test; fontSize:3; width:1;'></a-entity>
	
	<a-box id="test1" color="green" position="0 1 -6" scale="0.25 4 0.25" opacity="1">
		<a-box color="red" position="0 0.5 0" scale="1 0.2 1"> </a-box>
	</a-box>
	<a-box id="test2" color="green" position="0 1 -6" scale="0.25 4 0.25" opacity="1">
		<a-box color="red" position="0 0.5 0" scale="1 0.2 1"> </a-box>
	</a-box>

  </a-scene>
</html>

<script>

var sim = new altspace.utilities.Simulation(); //simulation

//read song from external file?

var song1 = ["01", "12", "35", "78", "08", "74", "63", "01", "23", "28", "83", "74", "18", "48", "63", "00", "54", "99"];  //99 signals pause
//var song1 = ["99", "99", "01", "45", "99"];
//var oneD_beau = ["99", "99", "46", "46", "46", "67", "67", "16", "16", "56", "68", "35", "68", "35", "44"]; //testing
//var song1 = ["99", "00", "11", "22", "33", "44", "55", "66", "77", "88", "99"];

console.log(song1);
var songStarted = false;

var tick = setInterval(tick, 1000);
var tick200 = setInterval(tick200, 200);
var ticker = 0;

var songAhead;
var song;
var s_str1;
var s_str2;

var boxTouched = ["9", "9"];
var hit = false; //did the user hit the box?
var hitCounter = 0;

var counterUpdated = false; //used to make sure counter only updates once


var oldRot1, oldRot2 = "0 0 0";
var newRot1, newRot2;
//runs every second
function tick(){
	
	if (songStarted == true){
	
		//show box to hit
		document.querySelector('#tempDisplay').setAttribute('n-text', "text:" + song1[(ticker)]);
		
		//reset some variables
		hit = false; //sets hit to false
		counterUpdated = false;
		
		//stores current part of song?
		song = song1[ticker];
	
		songAhead = song1[ticker]; //remove this possibly
		s_str1 = songAhead.substring(0,1);
		s_str2 = songAhead.substring(1);
		console.log(s_str1 + " | "  + s_str2);

		//console.log(song1[ticker]);
		//console.log(ticker + " | " + (song1.length-1));
	
		//parse array input (where number represent boxes to hit)
		
		
		
		//set all colours to normal
		//blank();
		getBoxNumbers(); //makes code cleaner
	
		ticker++;
	
		//console.log("ticker: " + ticker + " | songlength-1 : " + (song1.length-1));
	
		if (ticker >= (song1.length-1)){
			songStarted = false;
			ticker = 0;
			console.log("song ended");
			console.log("You hit " + hitCounter + "/" + (song1.length-1) + " moves");
			
			document.querySelector('#statsDisplay').setAttribute('n-text', "text:" + "You hit " + hitCounter + "/" + (song1.length-1) + " moves");
			
		}
	
	}
	
	

}//end tick function

function tick200(){

	if (songStarted == true){
		if ((song.includes(boxTouched[0]) && song.includes(boxTouched[1])) || hit==true){
			console.log("hit");
			hit = true;
			
			//makes sure counter only gets updated once
			if (counterUpdated == false){
				hitCounter ++;
				counterUpdated = true;
			}
			
			document.querySelector('#hitDisplay').setAttribute('n-text', 'text: hit');
		} else { 
			console.log("miss");
			document.querySelector('#hitDisplay').setAttribute('n-text', 'text: miss');
		}
	}
	
}

function blank(){

	document.querySelector('#box0').emit('left');
	document.querySelector('#box1').emit('left');
	document.querySelector('#box2').emit('left');
	document.querySelector('#box3').emit('left');
	document.querySelector('#box4').emit('left');
	document.querySelector('#box5').emit('left');
	document.querySelector('#box6').emit('left');
	document.querySelector('#box7').emit('left');
	document.querySelector('#box8').emit('left');

}

//keeping clean code
function getBoxNumbers(){

	//reset box scales
	document.querySelector('#test1').setAttribute('scale', '0.25, 4, 0.25');
	document.querySelector('#test2').setAttribute('scale', '0.25, 4, 0.25');

	switch(parseInt(s_str1)){
		case 0:
		
			newRot1 = "0 0 45";
			
		break;
		case 1:
	
			newRot1 = "0 0 0";
			
		break;
		case 2:
			newRot1 = "0 0 -45";
		break;
		case 3:
			newRot1 = "0 0 90";
		break;
		case 4:
			//document.querySelector('#test1').setAttribute('position', "0 1.5 -6.7");
			document.querySelector('#test1').setAttribute('scale', "0.25, 1, 0.25");
			
			newRot1 ="0 0 0";
			//idk how to do the rotation for this?
		break;
		case 5: 
			//document.querySelector('#test1').setAttribute('position', "0.5 1.5 -6.7");
			newRot1 = "0 0 270";
		break;
		case 6:
			//document.querySelector('#test1').setAttribute('position', "-0.5 1 -6.7");
			newRot1 = "0 0 135";
		break;
		case 7:
			//document.querySelector('#test1').setAttribute('position', "0 1 -6.7");
			newRot1 = "0 0 180";
		break;
		case 8:
			//document.querySelector('#test1').setAttribute('position', "0.5 1 -6.7");
			newRot1 = "0 0 225";
		break;
		case 9:
			//console.log("song end");
		break;
	 }//end switch
	 
	 //can be moved to end of switch?
	document.querySelector('#test1').setAttribute('rotation', newRot1);

	oldRot1 = newRot1;
	 
	 switch(parseInt(s_str2)){
		case 0: 
			//document.querySelector('#test2').setAttribute('position', "-0.5 2 -6.7");
			newRot2 = "0 0 45";
		break;
		case 1:
			//cument.querySelector('#test2').setAttribute('position', "0 2 -6.7");
			newRot2 = "0 0 0";
		break;
		case 2:
			//document.querySelector('#test2').setAttribute('position', "0.5 2 -6.7");
			newRot2 = "0 0 315";
		break;
		case 3:
			//document.querySelector('#test2').setAttribute('position', "-0.5 1.5 -6.7");
			newRot2 = "0 0 90";
		break;
		case 4: 
			//document.querySelector('#test2').setAttribute('position', "0 1.5 -6.7");
			document.querySelector('#test2').setAttribute('scale', "0.25, 1, 0.25");
			newRot2 ="0 0 0";
		break;
		case 5:
			//document.querySelector('#test2').setAttribute('position', "0.5 1.5 -6.7");
			newRot2 = "0 0 270";
		break;
		case 6:
			//document.querySelector('#test2').setAttribute('position', "-0.5 1 -6.7");
			newRot2 = "0 0 135";
		break;
		case 7:
			//document.querySelector('#test2').setAttribute('position', "0 1 -6.7");
			newRot2 = "0 0 180";
		break;
		case 8:
			//document.querySelector('#test2').setAttribute('position', "0.5 1 -6.7");
			newRot2 = "0 0 225";
		break;
		case 9:
			//console.log("song end");
			break;
	 }//end switch

	  //can be moved to end of switch?
	document.querySelector('#test2').setAttribute('rotation', newRot2);

	oldRot2 = newRot2;
	 
}

AFRAME.registerComponent('hancol',
                         {
  schema: 
  { 
    jointCubeSize: {
      type: 'float',
      default: 0.15
    },
	box_id:
	{
		type: 'int'
	}
  },

  init: function ()
  {
    var self = this;
    var object = self.el.object3D;

    object.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents
                       ({

      joints: [['Hand', 'Right', 0],['Hand', 'Left', 0]], jointCubeSize: self.data.jointCubeSize

    }));

    object.addEventListener('jointcollisionenter', handleJoin);		
    function handleJoin(event)
    {
      console.log('hand entered ' + self.data.box_id);
     
	 switch(self.data.box_id){
		case 0:
			document.querySelector('#box0').emit('touch');
		break;
		case 1:
			document.querySelector('#box1').emit('touch'); 
		break;
		case 2:
			document.querySelector('#box2').emit('touch'); 
		break;
		case 3:
			document.querySelector('#box3').emit('touch'); 
		break;
		case 4:
			document.querySelector('#box4').emit('touch'); 
		break;
		case 5:
			document.querySelector('#box5').emit('touch');	
		break;
		case 6:
			document.querySelector('#box6').emit('touch'); 
		break;
		case 7:
			document.querySelector('#box7').emit('touch'); 
		break;
		case 8:
			document.querySelector('#box8').emit('touch'); 
		break;
	 }//end switch
	 
	 //boxTouched.push("" + self.data.box_id);
	
	 
	 if (boxTouched[0] == "9"){
		boxTouched[0] = ""+self.data.box_id;
	 } else if (boxTouched[1] == "9"){
		boxTouched[1] = ""+self.data.box_id;
	 }
	  console.log(boxTouched);
	 
    }


    object.addEventListener('jointcollisionleave', handleLeave);
    function handleLeave(event)
    {
      console.log('hand exited ' + self.data.box_id);

	  switch(self.data.box_id){
		case 0:
			document.querySelector('#box0').emit('left'); 
		break;
		case 1:
			document.querySelector('#box1').emit('left'); 
		break;
		case 2:
			document.querySelector('#box2').emit('left'); 
		break;
		case 3:
			document.querySelector('#box3').emit('left'); 
		break;
		case 4:
			document.querySelector('#box4').emit('left'); 
		break;
		case 5:
			document.querySelector('#box5').emit('left'); 
		break;
		case 6:
			document.querySelector('#box6').emit('left'); 
		break;
		case 7:
			document.querySelector('#box7').emit('left'); 
		break;
		case 8:
			document.querySelector('#box8').emit('left'); 
		break;
	 }//end switch
 
	var btTemp1;
	var btTemp2;
	
	btTemp1 = boxTouched[0];
	btTemp2 = boxTouched[1];
	
	if (self.data.box_id == btTemp1){
		console.log(btTemp1);
		boxTouched[0] = "9";
	} else if (self.data.box_id == btTemp2){
		boxTouched[1] = "9";
	}
	//console.log(boxTouched);
	

    }
  }
});

//buttons
var redMat = new THREE.MeshBasicMaterial( { color: 0xff0000 } );
var boxGeo = new THREE.BoxGeometry(1, 1, 1);
var startBox = new THREE.Mesh(boxGeo, redMat);

startBox.position.set(0, 1, 3);

sim.scene.add(startBox);

startBox.addEventListener('cursordown', function(){

	if (songStarted == false){
		console.log("start song");
		songStarted = true;
		hitCounter = 0;
	}
});

</script>